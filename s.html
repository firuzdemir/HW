<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>HW Questions Viewer</title>
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />

  <!-- MathJax config -->
  <script>
    window.MathJax = {
      tex: {
        inlineMath: [['$', '$'], ['\\(', '\\)']],
        displayMath: [['$$', '$$'], ['\\[', '\\]']]
      },
      svg: { fontCache: 'global' }
    };
  </script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js" defer></script>

  <style>
    body {
      font-family: 'Times New Roman', Times, serif;
      font-size: 12pt;
      margin: 2em;
    }

    #latex-display, #latex-display * {
      font-family: 'Times New Roman', Times, serif;
      font-size: 12pt;
    }

    .search-wrapper {
      display: flex;
      justify-content: center;
      margin-bottom: 1em;
    }

    #search {
      width: 80%;
      padding: 10px;
      font-size: 16px;
      border: 1px solid #ccc;
      border-radius: 8px;
      box-sizing: border-box;
    }

    #message {
      color: red;
      margin-top: 1em;
      min-height: 1.2em;
      text-align: center;
    }

    img {
      max-width: 100%;
      display: inline-block;
      margin-right: 1em;
      vertical-align: middle;
      height: auto;
    }

    @media print {
      body { margin: 0.2em; }
      img {
        max-width: none;
        height: auto;
        display: block;
        margin-bottom: 1em;
      }
      .search-wrapper, #message { display: none; }
    }

    .coveredImg {
      opacity: 0.0;
      pointer-events: none;
    }

    #latex-display.print-all .question-block {
      margin-bottom: 0;
      border-bottom: 1px solid #ccc;
      padding-bottom: 0.5em;
    }

    #latex-display.print-all .question-block:last-child {
      border-bottom: none;
      margin-bottom: 0;
      padding-bottom: 0;
    }

    #latex-display.print-test .question-block {
      border-bottom: none;
      padding-bottom: 0;
      margin-bottom: var(--custom-space, 1em);
    }

    /* New styles for exam header */
    #exam-header {
      font-family: 'Times New Roman', Times, serif;
      font-size: 12pt;
      margin-bottom: 1em;
    }

    #exam-header .header-row {
      margin-bottom: 0.3em;
    }

    #exam-header strong {
      font-weight: bold;
    }

    #exam-header .header-row.instructions {
      font-style: normal;
      font-weight: normal;
      font-size: 11pt;
      line-height: 1.3;
      color: #000;
    }
  </style>
</head>

<body>
  <div class="search-wrapper">
    <input type="text" id="search" placeholder="Enter question number (e.g., 9159, 7640, 6139...)" />
  </div>

  <div id="message"></div>
  <div id="test-header" style="display:none;">
    <div id="exam-header">
      <div class="header-row">
        <strong>Phys 1A – Final</strong>
      </div>
      <div class="header-row">
        <span><strong>Name:</strong> _______________________________</span>
        <span style="float: right;"><strong>Student ID:</strong> __________________</span>
      </div>
      <div class="header-row instructions">
        Answer <strong>ALL</strong> questions. Show all work and explain your reasoning to receive full credit. Neatness and clarity will count toward your grade. For multiple-choice questions, <strong>select only ONE</strong> answer and show supporting work to earn partial credit. (MC: 2 pts, Short Answer: 4 pts, Long Answer: 3 pts per part)
        <br><br>
        No aids can be used other than a basic scientific calculator. Failure to follow these directions (i.e. cheating) will be considered violations of the Academic Honesty and subject the student to disciplinary action.
      </div>
    </div>
  </div>
  <div id="latex-display"></div>

  <script defer>
    document.addEventListener("DOMContentLoaded", () => {
      // ============================= //
      // ✅ CONFIGURATION FLAGS        //
      // ============================= //
      
      // AUTO_LOAD_MODE options: "none", "test", "all"
      // "none" = show nothing on load
      // "test" = show specific questions on load
      // "all" = show all questions on load
      const AUTO_LOAD_MODE = "all"; // <--- Change to "all" or "none" or "test" if needed

      const SHOW_SOLUTION = true; // Show solutions on loaded questions (all/test/search)

      // specific questions for test load  
      const specific_QUESTIONS = [
        { id: 9, space: '-12%' },
        { id: 7, space: '10%' }
      ];

      const display = document.getElementById("latex-display");
      const message = document.getElementById("message");
      const input = document.getElementById("search");
      const testHeader = document.getElementById("test-header");

      // Your PHP backend base URL here:
      const PHP_BASE_URL = "https://firuzdemir.rf.gd/sdata.php";
      // const PHP_BASE_URL = "https://firuzdemir.github.io/HW/sdata.php";

      // Helper: Hide solution images if showSolution = false
      function process(content, showSolution) {
        const imgs = [...content.matchAll(/<img[^>]*>/gi)];
        if (!showSolution && imgs[1]) {
          content = content.replace(imgs[1][0], imgs[1][0].replace('<img', '<img class="coveredImg"'));
        }
        return content;
      }

      // Render one question by ID, with showSolution override
      async function renderQuestion(id, showSolution = SHOW_SOLUTION) {
        testHeader.style.display = "none"; // Hide header on individual question
        if (!id) {
          message.textContent = "Please enter a question number.";
          display.innerHTML = "";
          return;
        }
        message.textContent = "Loading...";
        display.innerHTML = "";
        display.classList.remove("print-all", "print-test");

        try {
          const response = await fetch(`${PHP_BASE_URL}?id=${encodeURIComponent(id)}`, { cache: "no-store" });
          if (!response.ok) throw new Error(`Server error: ${response.status}`);
          const data = await response.json();
          if (data.error) {
            message.textContent = data.error;
            display.innerHTML = "";
            return;
          }
          let content = process(data.content, showSolution);
          display.innerHTML = `<div class="question-block"><strong>${id}</strong> — ${content}</div>`;
          if (window.MathJax) MathJax.typesetPromise([display]);
          message.textContent = "";
        } catch (e) {
          message.textContent = "Error connecting to server.";
          display.innerHTML = "";
          console.error(e);
        }
      }

      // Fetch all question IDs (for full load)
      async function fetchAllQuestionIds() {
        try {
          const response = await fetch(`${PHP_BASE_URL}?all_ids=1`, { cache: "no-store" });
          if (!response.ok) throw new Error(`Server error: ${response.status}`);
          const ids = await response.json();
          if (!Array.isArray(ids) || ids.length === 0) throw new Error("No question IDs received");
          return ids.map(id => ({ id: id, space: '1em' }));
        } catch (e) {
          console.warn("Failed to fetch all question IDs from server. Using specific questions.");
          return specific_QUESTIONS;
        }
      }

      // Render all questions
      async function renderAllQuestions() {
        testHeader.style.display = "none"; // Hide header for all questions
        message.textContent = "Loading all questions...";
        display.innerHTML = "";
        display.classList.remove("print-test");
        display.classList.add("print-all");

        const questions = await fetchAllQuestionIds();
        for (const q of questions) {
          try {
            const response = await fetch(`${PHP_BASE_URL}?id=${q.id}`, { cache: "no-store" });
            const data = await response.json();
            let content = data.error ? `<em>${data.error}</em>` : process(data.content, SHOW_SOLUTION);
            display.innerHTML += `<div class="question-block" style="--custom-space: 0;"><strong>${q.id}</strong> — ${content}</div>`;
          } catch {
            display.innerHTML += `<div class="question-block"><strong>${q.id}</strong> — <em>Error loading</em></div>`;
          }
        }
        if (window.MathJax) MathJax.typesetPromise([display]);
        message.textContent = "";
      }

      // Render specific questions (test load) with numerical order labels and header
      async function rendertestQuestions() {
        testHeader.style.display = "block"; // Show header for test
        message.textContent = "Loading selected questions...";
        display.innerHTML = "";
        display.classList.remove("print-all");
        display.classList.add("print-test");

        for (let i = 0; i < specific_QUESTIONS.length; i++) {
          const q = specific_QUESTIONS[i];
          try {
            const response = await fetch(`${PHP_BASE_URL}?id=${q.id}`, { cache: "no-store" });
            const data = await response.json();
            let content = data.error ? `<em>${data.error}</em>` : process(data.content, SHOW_SOLUTION);
            // Show numerical order instead of actual question ID
            display.innerHTML += `<div class="question-block" style="--custom-space: ${q.space};"><strong>${i + 1}</strong> — ${content}</div>`;
          } catch {
            display.innerHTML += `<div class="question-block" style="--custom-space: ${q.space};"><strong>${i + 1}</strong> — <em>Error loading</em></div>`;
          }
        }
        if (window.MathJax) MathJax.typesetPromise([display]);
        message.textContent = "";
      }

      // Debounce helper function
      function debounce(func, wait) {
        let timeout;
        return function(...args) {
          clearTimeout(timeout);
          timeout = setTimeout(() => func.apply(this, args), wait);
        };
      }

      // Search input handlers
      input.addEventListener("focus", () => {
        input.value = "";
        message.textContent = "";
      });

      // Replace keydown Enter with debounced input event for live search
      input.addEventListener("input", debounce(() => {
        const val = input.value.trim();
        const num = parseInt(val, 10);
        if (!val || isNaN(num)) {
          message.textContent = "Please enter a valid question number.";
          display.innerHTML = "";
          testHeader.style.display = "none"; // Hide header for search
          return;
        }
        renderQuestion(num, SHOW_SOLUTION);
      }, 300));

      // Auto-load based on AUTO_LOAD_MODE
      if (AUTO_LOAD_MODE === "all") {
        renderAllQuestions();
      } else if (AUTO_LOAD_MODE === "test") {
        rendertestQuestions();
      } else {
        // none = do not auto load anything
        testHeader.style.display = "none";
        message.textContent = "";
        display.innerHTML = "";
      }
    });
  </script>
</body>
</html>

